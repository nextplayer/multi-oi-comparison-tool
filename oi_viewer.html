<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OI Viewer</title>
    <!-- Google API Scripts -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #2a2a2a;
            color: #e0e0e0;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 1680px;
            margin: 0 auto;
            background: #3a3a3a;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            padding: 32px;
            box-sizing: border-box;
        }

        .input-container {
            width: 100%;
            margin-bottom: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .fetch-button {
            padding: 18px 36px;
            font-size: 18px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .fetch-button:hover {
            background-color: #45a049;
        }

        .fetch-button.drag-over {
            background-color: #2e7d32;
        }

        .chart-container {
            width: 100%;
            margin-top: 12px;
            border: 1px solid #555;
            border-radius: 10px;
            padding: 24px;
            background-color: #444;
            box-sizing: border-box;
        }

        .chart-wrapper {
            width: 100%;
            min-height: 800px;
        }

        .file-input {
            position: absolute;
            left: -9999px;
            opacity: 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="input-container">
            <label for="csvFileInput1" id="fetchButton1" class="fetch-button">Open Interest CSV</label>
            <input type="file" id="csvFileInput1" accept=".csv" class="file-input">
        </div>

        <hr style="height:2px;border-width:0;color:gray;background-color:gray;width:100%;">

        <div class="chart-container">
            <div id="chartOI" class="chart-wrapper"></div>
        </div>
    </div>
    <!-- <div class="footer">Developed by Sepp</div> -->
    <!-- Plotly.js from CDN -->
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <script>
        // ===== Google Drive API 設定 =====
        const GOOGLE_CONFIG = {
            CLIENT_ID: '1033958660645-45g683r139ike9j0s0viusf4prq72hh1.apps.googleusercontent.com',
            API_KEY: 'AIzaSyCW-kR4HLNNIlIDBeIvCpXVxZDwof7Jq9s', // 需要從 Google Cloud Console 取得
            SCOPES: 'https://www.googleapis.com/auth/drive.readonly',
            DISCOVERY_DOCS: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
            FOLDER_NAME: 'ThetaDataOI'
        };

        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let accessToken = null;
        let pickerApiLoaded = false;
        let currentPickerCallback = null;

        // 初始化 Google API
        function gapiLoaded() {
            gapi.load('client:picker', initializeGapiClient);
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: GOOGLE_CONFIG.API_KEY,
                    discoveryDocs: GOOGLE_CONFIG.DISCOVERY_DOCS,
                });
                gapiInited = true;
                maybeEnableButtons();
            } catch (error) {
                console.error('Error initializing GAPI client:', error);
            }
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CONFIG.CLIENT_ID,
                scope: GOOGLE_CONFIG.SCOPES,
                callback: (response) => {
                    if (response.error !== undefined) {
                        console.error('Token error:', response);
                        alert('Google 認證失敗，請重試。');
                        return;
                    }
                    accessToken = response.access_token;
                    if (currentPickerCallback) {
                        createPicker(currentPickerCallback);
                    }
                },
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                console.log('Google API 已就緒');
            }
        }

        // 尋找 ThetaDataOI 資料夾
        async function findThetaDataFolder() {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${GOOGLE_CONFIG.FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });

                const files = response.result.files;
                if (files && files.length > 0) {
                    return files[0].id;
                }

                console.warn(`找不到資料夾: ${GOOGLE_CONFIG.FOLDER_NAME}`);
                return null;
            } catch (error) {
                console.error('尋找資料夾時發生錯誤:', error);
                return null;
            }
        }

        // 建立 Google Picker
        async function createPicker(callback) {
            const folderId = await findThetaDataFolder();

            if (!folderId) {
                alert(`找不到 Google Drive 資料夾 "${GOOGLE_CONFIG.FOLDER_NAME}"，請確認資料夾存在。`);
                return;
            }

            const view = new google.picker.DocsView(google.picker.ViewId.DOCS)
                .setParent(folderId)
                .setIncludeFolders(true)  // 改為 true，顯示資料夾
                .setSelectFolderEnabled(false)  // 不允許選擇資料夾本身
                .setMimeTypes('text/csv,application/vnd.ms-excel');

            const picker = new google.picker.PickerBuilder()
                .setAppId(GOOGLE_CONFIG.CLIENT_ID.split('-')[0])
                .setOAuthToken(accessToken)
                .addView(view)
                .setDeveloperKey(GOOGLE_CONFIG.API_KEY)
                .setCallback((data) => pickerCallback(data, callback))
                .setTitle(`選擇 CSV 檔案 - ${GOOGLE_CONFIG.FOLDER_NAME}`)
                .build();

            picker.setVisible(true);
        }

        // Picker 回調函數
        function pickerCallback(data, userCallback) {
            if (data.action === google.picker.Action.PICKED) {
                const file = data.docs[0];
                downloadFileFromDrive(file.id, file.name, userCallback);
            }
        }

        // 從 Google Drive 下載檔案
        async function downloadFileFromDrive(fileId, fileName, callback) {
            try {
                const response = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });

                const content = response.body;

                // 建立一個模擬的 File 物件
                const blob = new Blob([content], { type: 'text/csv' });
                const file = new File([blob], fileName, { type: 'text/csv' });

                if (callback) {
                    callback(file);
                }
            } catch (error) {
                console.error('下載檔案時發生錯誤:', error);
                alert(`下載檔案失敗: ${error.message}`);
            }
        }

        // 開啟 Picker 的主要函數
        function openGooglePicker(callback) {
            currentPickerCallback = callback;

            if (!gapiInited || !gisInited) {
                alert('Google API 尚未初始化，請稍後再試。');
                return;
            }

            if (!accessToken) {
                // 需要授權
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                // 已有 token，直接開啟 picker
                createPicker(callback);
            }
        }

        // 載入 Google API
        window.addEventListener('load', () => {
            if (typeof gapi !== 'undefined') {
                gapiLoaded();
            }
            if (typeof google !== 'undefined' && google.accounts) {
                gisLoaded();
            }
        });

        // ===== 原有的常數定義 =====
        // Color palette for different expirations
        const colorPalette = [
            'rgb(255,111,0)',   // Orange
            'rgb(151,255,0)',   // Green
            'rgb(44,255,150)',  // Cyan
            'rgb(0,25,255)',    // Blue
            'rgb(0,0,200)',     // Dark Blue
            'rgb(150,0,90)',    // Purple
            'rgb(255,0,0)',     // Red
            'rgb(0,255,255)',   // Aqua
            'rgb(255,255,0)',   // Yellow
            'rgb(128,0,128)'    // Violet
        ];

        // 檔案輸入處理
        const fetchButton = document.getElementById('fetchButton1');
        const fileInput = document.getElementById('csvFileInput1');

        // 點擊按鈕時開啟 Google Picker
        fetchButton.addEventListener('click', (event) => {
            event.preventDefault();
            openGooglePicker(async (file) => {
                await processFile(file);
            });
        });

        // 保留原有的檔案選擇功能（作為備選）
        fileInput.addEventListener('change', async function (event) {
            const file = event.target.files[0];
            await processFile(file);
            event.target.value = "";
        });

        // 拖放功能
        ['dragenter', 'dragover'].forEach((eventName) => {
            fetchButton.addEventListener(eventName, (event) => {
                event.preventDefault();
                event.stopPropagation();
                fetchButton.classList.add('drag-over');
            });
        });

        ['dragleave', 'dragend'].forEach((eventName) => {
            fetchButton.addEventListener(eventName, (event) => {
                event.preventDefault();
                event.stopPropagation();
                fetchButton.classList.remove('drag-over');
            });
        });

        fetchButton.addEventListener('drop', async (event) => {
            event.preventDefault();
            event.stopPropagation();
            fetchButton.classList.remove('drag-over');
            const file = event.dataTransfer?.files?.[0];
            await processFile(file);
        });

        // 處理檔案的統一函數
        async function processFile(file) {
            if (!file) {
                return;
            }

            try {
                let content;
                if (typeof file.text === "function") {
                    content = await file.text();
                } else {
                    content = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsText(file);
                    });
                }

                // 去掉 .csv 副檔名
                const filename = file.name.replace(/\.csv$/i, '');
                parseAndPlotCSV(content, filename);
            } catch (error) {
                console.error('處理檔案時發生錯誤:', error);
                alert(`處理檔案失敗：${error.message}`);
            }
        }

        function parseAndPlotCSV(csvData, filename = '') {
            const lines = csvData.trim().split('\n');
            const headers = lines[0].split(',');

            // Parse CSV data
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length === headers.length) {
                    data.push({
                        symbol: values[0],
                        expiration: values[1],
                        strike: parseFloat(values[2]),
                        right: values[3],
                        timestamp: values[4],
                        open_interest: parseInt(values[5])
                    });
                }
            }

            // Group data by expiration and strike
            const expirations = [...new Set(data.map(d => d.expiration))].sort();
            const strikes = [...new Set(data.map(d => d.strike))].sort((a, b) => a - b);

            // Prepare data for plotting
            const callTraces = [];
            const putTraces = [];

            expirations.forEach((exp, idx) => {
                const expData = data.filter(d => d.expiration === exp);
                const color = colorPalette[idx % colorPalette.length];

                // Call data
                const callOI = strikes.map(strike => {
                    const record = expData.find(d => d.strike === strike && d.right === 'CALL');
                    return record ? record.open_interest : 0;
                });

                // Put data (negative for left side)
                const putOI = strikes.map(strike => {
                    const record = expData.find(d => d.strike === strike && d.right === 'PUT');
                    return record ? -record.open_interest : 0;
                });

                // Calculate DTE (days to expiration)
                const dte = calculateDTE(exp);
                const expLabel = `${exp} (${dte}dte)`;

                callTraces.push({
                    x: callOI,
                    y: strikes,
                    name: expLabel,
                    type: 'bar',
                    orientation: 'h',
                    marker: { color: color },
                    legendgroup: exp,
                    hovertemplate: `<b>${expLabel} CALL</b><br>Strike: %{y}<br>OI: %{x}<extra></extra>`
                });

                putTraces.push({
                    x: putOI,
                    y: strikes,
                    name: `${expLabel} PUT`,
                    type: 'bar',
                    orientation: 'h',
                    marker: { color: color },
                    legendgroup: exp,
                    showlegend: false,
                    // text: y,
                    customdata: putOI.map(v => Math.abs(v)),
                    hovertemplate: `<b>${expLabel} PUT</b><br>Strike: %{y}<br>OI: %{customdata}<extra></extra>`
                });
            });

            // 交錯排列:每個到期日的 PUT 和 CALL 配對
            const traces = [];
            for (let i = 0; i < expirations.length; i++) {
                traces.push(callTraces[i]);  // 先 CALL
                traces.push(putTraces[i]);   // 後 PUT
            }

            // Calculate total OI per strike (sum across all expirations)
            const totalCallOIPerStrike = strikes.map((strike, idx) => {
                return callTraces.reduce((sum, trace) => sum + trace.x[idx], 0);
            });

            const totalPutOIPerStrike = strikes.map((strike, idx) => {
                return putTraces.reduce((sum, trace) => sum + Math.abs(trace.x[idx]), 0);
            });

            // Find max total OI across all strikes
            const maxTotalCallOI = Math.max(...totalCallOIPerStrike);
            const maxTotalPutOI = Math.max(...totalPutOIPerStrike);
            const maxOI = Math.max(maxTotalCallOI, maxTotalPutOI);
            const xRange = maxOI * 1.05;

            // Layout
            const layout = {
                title: {
                    text: `${data[0].symbol} OI Distribution`,
                    font: { size: 14 }
                },
                barmode: 'relative',
                xaxis: {
                    title: 'Open Interest',
                    range: [-xRange, xRange],
                    // autorange: true,
                    gridcolor: 'white',
                    linecolor: 'white',
                    tickfont: { size: 12 },
                    showgrid: true
                    // zeroline: true,
                    // zerolinecolor: "#ffffff",
                    // zerolinewidth: 1
                },
                yaxis: {
                    title: 'Strike Price',
                    gridcolor: 'white',
                    linecolor: 'white',
                    tickfont: { size: 12 },
                    showgrid: true,
                    autorange: true
                },
                shapes: [
                    {
                        type: 'line',
                        x0: 0,
                        x1: 0,
                        y0: 0,
                        y1: 1,
                        yref: 'paper',  // 使用相對座標,0=底部, 1=頂部
                        line: {
                            color: 'white',      // 線的顏色
                            width: 1,          // 線的寬度
                            dash: 'solid'      // 'solid', 'dash', 'dot', 'dashdot'
                        }
                    }
                ],
                plot_bgcolor: '#E5ECF6',
                paper_bgcolor: 'white',
                legend: {
                    orientation: "v",
                    x: 0.98,
                    y: 0.02,
                    xanchor: "right",
                    yanchor: "bottom",
                    font: { size: 10 },
                    itemwidth: 80,
                    bgcolor: "rgba(255,255,255,0)",
                    bordercolor: "#ccc",
                    borderwidth: 0
                },
                margin: { l: 60, r: 40, t: 40, b: 60 },
                height: 1200,
                annotations: [
                    {
                        x: -xRange * 0.5,
                        y: Math.max(...strikes),
                        text: 'PUT',
                        showarrow: false,
                        font: { size: 12, color: '#2a3f5f' }
                    },
                    {
                        x: xRange * 0.5,
                        y: Math.max(...strikes),
                        text: 'CALL',
                        showarrow: false,
                        font: { size: 12, color: '#2a3f5f' }
                    },
                    {
                        xref: 'paper',
                        yref: 'paper',
                        x: 0.99,
                        y: 0.99,
                        xanchor: 'right',
                        yanchor: 'top',
                        text: filename,
                        showarrow: false,
                        font: { size: 10, color: '#2a3f5f' }
                    }
                ]
            };
            const config = {
                responsive: true,
                displaylogo: false,
                modeBarButtonsToRemove: ["lasso2d", "select2d"],
                toImageButtonOptions: {
                    format: 'png',
                    filename: `${data[0].symbol}_oi_distribution`,
                    // height: 1080,
                    // width: 1920,
                    scale: 2
                }
            };
            Plotly.newPlot('chartOI', traces, layout, config);
        }

        function calculateDTE(expirationDate) {
            const expDate = new Date(expirationDate);
            const today = new Date();
            const diffTime = expDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }
    </script>
</body>

</html>